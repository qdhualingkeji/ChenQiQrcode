$(function(){function e(e){e=e.split("+").join(" ");for(var t,n={},a=/[?&]?([^=]+)=([^&]*)/g;t=a.exec(e);)n[decodeURIComponent(t[1])]=decodeURIComponent(t[2]);return n}function t(e){var t=/^[A-Za-z0-9]{32}$/;return t.test(e)?!0:!1}function n(){var e,n=window.location.search,a=new Object,i=[],s=!1,o="";if(-1!=n.indexOf("?")){var r=n.substr(1);e=r.split("&");for(var c=0;c<e.length;c++)i.push(e[c]),t(e[c])&&(s=!0,o=e[c]),a[e[c].split("=")[0]]=decodeURI(e[c].split("=")[1])}return{theRequest:a,len:e?e.length:0,key:i,has_codeString:s,codeString:o}}function a(e,t){$.ajax({type:"POST",url:"//"+CLI_DOMAIN+"/comment/pass",data:{id:e},success:function(e){1==e.status?t.removeAttr("data-type").removeClass("text-blue").addClass("text-grey"):alert(e.msg)},error:function(){console.log("网络错误")}})}function i(e,t,n){$.ajax({type:"POST",url:"//"+CLI_DOMAIN+"/comment/setTop",data:{id:e,topic_id:c},success:function(e){if(1==e.status)switch(t){case"setTop":n.parents(".comment-single").children(".comment-header").append('<span class="comment-topped">置顶</div>'),n.data("type","setUntop").text("取消置顶");break;case"setUntop":n.parents(".comment-single").children(".comment-header").children(".comment-topped").remove(),n.data("type","setTop").text("置顶")}else alert(e.msg)},error:function(){console.log("网络错误")}})}function s(e,t){$.ajax({type:"POST",url:"//"+CLI_DOMAIN+"/comment/delete",data:{id:e},success:function(e){1==e.status?t.parents(".comment-single").remove():alert(e.msg)},error:function(){console.log("网络错误")}})}function o(e,t,n){new_first_file_upload=!1,new commentsBox({el:"reply-box-"+e,cancel:!0,placeholderContent:" 回复给 "+t,marginTop:"15px",pid:e,submitSuccess:function(t,a,i){if($("[submit-btn]").button("reset"),0!=i)if(1==t.status){var s={username:account+"（我）",add_time:"刚刚",content:a.content},o=a.img_lists.map(function(e){return'<img class="reply-image" src="'+e.path+'?x-oss-process=image/resize,m_mfit,h_150,w_150" data-lity data-lity-target="'+e.path+'" />'}).join(" "),r=a.img_lists.length?'<div class="reply-images">'+o+"</div>":"",c=a.file_lists.map(function(e){return'<div class="reply-file"><a href="'+e.path+'" rel="nofollow" target="_blank"><i class="fa fa-paperclip"></i> '+e.name+"</a></div>"}).join(" "),d=a.file_lists.length?'<div class="reply-files">'+c+"</div>":"",p=l?'<div class="reply-action"><a href="javascript:;" class="text-grey">通过</a><a href="javascript:;" data-type="delete" class="text-blue">删除</a></div>':"",m=l?"reply-header is_official":"reply-header",u='\n<div class="reply-single" data-id='+t.data.comment_id+" data-pid="+i+'>\n	<div class="'+m+'">\n		'+s.username+' <span class="reply-time">'+s.add_time+'</span>\n	</div>\n	<p class="reply-content">'+s.content+"</p>\n"+r+d+p+"</div>\n";n.parents(".comment-single").children(".reply-list").length?n.parents(".comment-single").children(".reply-list").append(u):n.parents(".comment-action").before('<div class="reply-list">'+u+"</div>"),$("#reply-box-"+e).html(""),new_first_file_upload=!1}else alert(t.msg||t.info),$("#reply-box-"+e).html("");else submitFirstData(t,a,l)},submitFail:function(){alert("网络错误，请重试")}})}function r(){if(p.type){var e=$("#current-total")[0].innerHTML;$("#current-total").text(Number(e)-1)}else{var e=$(".comment-count")[0].innerHTML;$(".comment-count").text(Number(e)-1)}}var c=$("#topicId").val()||0,l=Number($("#isAdmin").val())||0,d=Number($("#hasError").val())||0,p=e(window.location.search),m=n();if(m&&1==m.has_codeString){var u=$("[query-code-string]"),f=m.codeString,h=m.key;if(h&&h.length>1)for(var g=0;g<h.length;g++)g>0&&(f=f+"&"+h[g]);u.each(function(e,t){var t=$(t),n=t.attr("href"),a=n.substr(0,1);if("?"==n)var i=n.replace(a,a+f);else var i=n.replace(a,a+f+"&");t.attr("href",i)})}d&&alert("页面加载错误"),$(document).on("click","#go-to-comment",function(){$("html, body").animate({scrollTop:$(".discuss-title:not(.none)").offset().top-64},400),setTimeout(function(){$("[text-content]").focus()},0)}),$(document).on("click",".comment-action > a",function(e){e.preventDefault();var t=$(this).parents(".comment-single").data("id"),n=$(this).parents(".comment-single").data("name"),c=$(this);switch($(this).data("type")){case"pass":a(t,$(this));var l=$(".comment-count")[0].innerHTML,d=JSON.parse(JSON.stringify($("#current-total")[0].innerHTML));$(".comment-count").text(Number(l)+1),$("#current-total").text(d);break;case"reply":$("[file-tag]").remove(),$("[img-box]").find("#wait").hide(),$("[file-box]").find("#wait").hide(),$(".text-content").val(""),$(".reply-box").html(""),""==account?seajs.use("//"+STATIC_SERVICE+"/js/login_plugin.js?v=20190610",function(e){e.login_plugin("login","",function(){$("#iframe").hide(),$("#login_join",window.parent.document).hide(),$("#close_login",window.parent.document).hide(),$("#login",window.parent.document).hide(),$("#myqr_out",window.parent.document).show(),o(t,n,c)},1,"")}):o(t,n,c);break;case"setTop":i(t,"setTop",$(this));break;case"setUntop":i(t,"setUntop",$(this));break;case"delete":window.confirm("你确定删除这条评论吗?")&&(s(t,$(this)),r())}}),$(document).on("click",".reply-action > a",function(e){e.preventDefault();var t=$(this).parents(".reply-single").data("id"),n=($(this).parents(".reply-single").data("name"),$(this).parents(".reply-single"));switch($(this).data("type")){case"pass":a(t,$(this));break;case"edit":console.log("编辑回复");break;case"delete":window.confirm("你确定删除这条回复吗?")&&$.ajax({type:"POST",url:"//"+CLI_DOMAIN+"/comment/delete",data:{id:t},success:function(e){1==e.status?n.remove():alert(e.msg)},error:function(){console.log("网络错误")}})}})});